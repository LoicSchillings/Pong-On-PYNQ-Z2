#include "game.h"

game_state_t game;

void game_init(void)
{
    game.p1_y = (SCREEN_H - PADDLE_H) / 2;
    game.p2_y = (SCREEN_H - PADDLE_H) / 2;

    game.ball_x = SCREEN_W / 2;
    game.ball_y = SCREEN_H / 2;
    game.ball_vx = 4;
    game.ball_vy = 3;

    state.score_p1 = 0;
    state.score_p2 = 0;
    state.mode = GAME_WAIT_START;
    state.p1_ready = 0;
    state.p2_ready = 0;

}

void game_apply_command(game_cmd_t cmd)
{
    if (cmd == CMD_RESET) {
        game_reset_full();
        return;
    }

    if (state.mode == GAME_WAIT_START) {
        if (cmd == CMD_P1_READY) state.p1_ready = 1;
        if (cmd == CMD_P2_READY) state.p2_ready = 1;

        if (state.p1_ready && state.p2_ready) {
            state.mode = GAME_RUNNING;
            game_reset_ball(+1);
        }
        return;
    }

    if (state.mode != GAME_RUNNING)
        return;

    switch (cmd) {
        case CMD_P1_UP:   state.p1.y -= PADDLE_SPEED; break;
        case CMD_P1_DOWN: state.p1.y += PADDLE_SPEED; break;
        case CMD_P2_UP:   state.p2.y -= PADDLE_SPEED; break;
        case CMD_P2_DOWN: state.p2.y += PADDLE_SPEED; break;
        default: break;
    }
}

void game_update(void)
{

    game.ball_x += game.ball_vx;
    game.ball_y += game.ball_vy;

    // Top / bottom bounce
    if (game.ball_y <= 0 || game.ball_y >= SCREEN_H - BALL_SIZE)
        game.ball_vy = -game.ball_vy;

    // Paddle collisions
    if (game.ball_x <= 40 &&
        game.ball_y + BALL_SIZE >= game.p1_y &&
        game.ball_y <= game.p1_y + PADDLE_H)
        game.ball_vx = -game.ball_vx;

    if (game.ball_x >= SCREEN_W - 40 &&
        game.ball_y + BALL_SIZE >= game.p2_y &&
        game.ball_y <= game.p2_y + PADDLE_H)
        game.ball_vx = -game.ball_vx;

    if (state.mode != GAME_RUNNING)
        return;

    /* Left wall -> Player 2 scores */
    if (state.ball.x < 0) {
        state.score_p2++;
        game_reset_ball(+1);
    }

    /* Right wall -> Player 1 scores */
    if (state.ball.x > SCREEN_WIDTH) {
        state.score_p1++;
        game_reset_ball(-1);
    }

    /* Win condition */
    if (state.score_p1 >= 5 || state.score_p2 >= 5) {
        state.mode = GAME_GAMEOVER;
    }
}

void game_reset_full(void)
{
    state.score_p1 = 0;
    state.score_p2 = 0;
    state.p1_ready = 0;
    state.p2_ready = 0;
    state.mode = GAME_WAIT_START;
}
